apiVersion: v1
kind: Namespace
metadata:
  name: agents
  labels:
    name: agents
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: livekit-agent
  namespace: agents
  labels:
    app: livekit-agent
spec:
  replicas: 4
  selector:
    matchLabels:
      app: livekit-agent
  template:
    metadata:
      labels:
        app: livekit-agent
    spec:
      nodeSelector:
        agentpool: agents
      tolerations:
      - key: agents
        operator: Equal
        value: "true"
        effect: NoSchedule
      containers:
      - name: agent
        image: acrvoiceassistantprod.azurecr.io/livekit-agent:latest
        env:
        - name: ENVIRONMENT
          value: "production"
        - name: LIVEKIT_URL
          value: "ws://livekit-server.livekit-system.svc.cluster.local:7880"
        - name: LIVEKIT_API_KEY
          valueFrom:
            secretKeyRef:
              name: livekit-secrets
              key: api-key
        - name: LIVEKIT_API_SECRET
          valueFrom:
            secretKeyRef:
              name: livekit-secrets
              key: api-secret
        - name: BACKEND_API_URL
          value: "http://fastapi-service.api.svc.cluster.local:8000"
        - name: BACKEND_API_KEY
          valueFrom:
            secretKeyRef:
              name: backend-secrets
              key: api-key
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-secrets
              key: connection-string
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: ai-provider-secrets
              key: openai-api-key
        - name: STT_PROVIDER
          value: "openai"
        - name: LLM_PROVIDER
          value: "openai"
        - name: TTS_PROVIDER
          value: "openai"
        - name: LLM_MODEL
          value: "gpt-4"
        - name: TTS_VOICE
          value: "alloy"
        - name: LOG_LEVEL
          value: "INFO"
        resources:
          requests:
            cpu: "1000m"
            memory: "2Gi"
          limits:
            cpu: "2000m"
            memory: "4Gi"
        livenessProbe:
          exec:
            command:
            - python
            - -c
            - "import sys; sys.exit(0)"
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: livekit-agent-hpa
  namespace: agents
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: livekit-agent
  minReplicas: 4
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 75
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 2
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Pods
        value: 4
        periodSeconds: 60
